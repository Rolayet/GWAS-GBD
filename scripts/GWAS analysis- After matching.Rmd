---
title: "GWAS analysis- After matching"
output: html_notebook
---


```{r}
library(dplyr)
library(data.table)
library(tidyr)
library(stringr)
library(ggplot2)
library(stats)
library(readr)
library(readxl)
library(openxlsx)
  
```


read the data 

```{r}

combined_dataset <- fread("/Users/rayanaloliet/Desktop/GWAS Catalog/combined_dataset_ncase.csv")

```


exclude GBD teams that are classified as Injuries

```{r}

# List of injuries to exclude
terms_to_exclude <- c("Injuries", "Transport injuries", "Road injuries", 
                         "Pedestrian road injuries", "Cyclist road injuries", 
                         "Motorcyclist road injuries", "Motor vehicle road injuries", 
                         "Other road injuries", "Other transport injuries", 
                         "Unintentional injuries", "Falls", "Drowning", 
                         "Fire, heat, and hot substances", "Poisonings", 
                         "Poisoning by carbon monoxide", "Poisoning by other means", 
                         "Exposure to mechanical forces", "Unintentional firearm injuries", 
                         "Other exposure to mechanical forces", "Adverse effects of medical treatment", 
                         "Animal contact", "Venomous animal contact", 
                         "Non-venomous animal contact", "Foreign body", 
                         "Pulmonary aspiration and foreign body in airway", 
                         "Foreign body in eyes", "Foreign body in other body part", 
                         "Environmental heat and cold exposure", "Exposure to forces of nature", 
                         "Other unintentional injuries", "Self-harm and interpersonal violence", 
                         "Self-harm", "Self-harm by firearm", "Self-harm by other specified means", 
                         "Interpersonal violence", "Physical violence by firearm", 
                         "Physical violence by sharp object", "Sexual violence", 
                         "Physical violence by other means", "Conflict and terrorism", 
                         "Police conflict and executions")

 # Filter the GBD DALY data for "Number" metric and rename columns
filtered_dataset <- combined_dataset %>%
  filter(!(`GBD term` %in% terms_to_exclude))  # Exclude specified terms


```


read the data - other file from the GBD for terms classification

```{r}
broader_categories_dataset<- read_xlsx("/Users/rayanaloliet/Desktop/GWAS Catalog/GBD_2021_CAUSE_HIERARCHY_Y2024M05D16.xlsx")
 
head(broader_categories_dataset)
```

check the numbers before the merging 

```{r}
# Calculate the sum of the column
total_sum <- sum(filtered_dataset$total_attention_score, na.rm = TRUE)

# Print the result
print(total_sum)
```

Rename `GBD term` to `Cause Name` in filtered_dataset for merging

```{r}
filtered_dataset <- filtered_dataset %>%
  rename(`Cause Name` = `GBD term`)
```


 Merge the datasets on `Cause Name`

```{r}
merged_dataset <- merge(filtered_dataset, broader_categories_dataset, by = "Cause Name", all.x = TRUE)
```

Summarize the total_attention_score by Parent Name (broader category)

```{r}
summarized_data <- merged_dataset %>%
  group_by(`Parent Name`) %>%
  summarise(total_attention_score = sum(total_attention_score, na.rm = TRUE), .groups = 'drop') %>%
  rename(Category_2 = `Parent Name`)
```


check the numbers after for the merging 

```{r}
# Calculate the sum of the column
total_sum <- sum(summarized_data$total_attention_score, na.rm = TRUE)

# Print the result
print(total_sum)
```

Create a bubble plot


```{r}
bubble_plot <- ggplot(summarized_data, aes(x = Category_2, y = total_attention_score, size = total_attention_score, label = Category_2)) +
  geom_point(alpha = 0.7, color = "skyblue") +
  geom_text(vjust = 1.5, size = 3.5) +
  theme_minimal() +
  labs(title = "Bubble Plot of Total Attention Score by Broader Category",
       x = "Broader Category",
       y = "Total Attention Score",
       size = "Total Attention Score") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

bubble_plot
```

Define the thresholds 

```{r}
# Define the thresholds for the categories
quantiles <- quantile(summarized_data$total_attention_score, probs = c(0, 0.25, 0.5, 0.75, 1))

# Categorize the scores
summarized_data <- summarized_data %>%
  mutate(category = case_when(
    total_attention_score <= quantiles[2] ~ "Very Low",
    total_attention_score <= quantiles[3] ~ "Low",
    total_attention_score <= quantiles[4] ~ "Medium",
    TRUE ~ "High"
  ))

```


plot for each category

```{r}

# Function to create bubble plots for each category
create_bubble_plot <- function(data, category) {
  ggplot(data, aes(x = Category_2, y = total_attention_score, size = total_attention_score, label = Category_2)) +
    geom_point(alpha = 0.7, color = "skyblue") +
    geom_text(vjust = 1.5, size = 3.5) +
    theme_minimal() +
    labs(title = paste("Bubble Plot of Total Attention Score -", category),
         x = "Broader Category",
         y = "Total Attention Score",
         size = "Total Attention Score") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

# Create and save bubble plots for each category
categories <- unique(summarized_data$category)
for (cat in categories) {
  cat_data <- summarized_data %>% filter(category == cat)
  bubble_plot <- create_bubble_plot(cat_data, cat)
  print(bubble_plot)
  ggsave(paste0("bubble_plot_", tolower(cat), ".png"), plot = bubble_plot, width = 12, height = 8)
}
```
Create a treemap


```{r}
treemap_plot <- ggplot(summarized_data, aes(area = total_attention_score, fill = category, label = Category_2)) +
  geom_treemap() +
  geom_treemap_text(fontface = "italic", colour = "white", place = "centre", grow = TRUE) +
  scale_fill_manual(values = c("Very Low" = "#FFDDC1", "Low" = "#FFABAB", "Medium" = "#FF6F91", "High" = "#FFC75F")) +
  theme_minimal() +
  labs(title = "Treemap of Total Attention Score by Category",
       fill = "Category") +
  theme(legend.position = "bottom")

 treemap_plot

```

bar plots 

```{r}
# Function to create bar plots for each category
create_bar_plot <- function(data, category) {
  ggplot(data, aes(x = reorder(Category_2, -total_attention_score), y = total_attention_score, fill = Category_2)) +
    geom_bar(stat = "identity") +
    coord_flip() +
    theme_minimal() +
    labs(title = paste("Bar Plot of Total Attention Score -", category),
         x = "Broader Category",
         y = "Total Attention Score") +
    theme(legend.position = "none",
          axis.text.y = element_text(size = 10))
}

# Create and save bar plots for each category
categories <- unique(summarized_data$category)
for (cat in categories) {
  cat_data <- summarized_data %>% filter(category == cat)
  bar_plot <- create_bar_plot(cat_data, cat)
  print(bar_plot)
  ggsave(paste0("bar_plot_", tolower(cat), ".png"), plot = bar_plot, width = 12, height = 8)
}

```


# Create a faceted bar plot

```{r}
faceted_bar_plot <- ggplot(summarized_data, aes(x = reorder(Category_2, total_attention_score), y = total_attention_score, fill = category)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  facet_wrap(~ category, scales = "free_y") +
  theme_minimal() +
  labs(title = "Faceted Bar Plot of Total Attention Score by Category",
       x = "Broader Category",
       y = "Total Attention Score",
       fill = "Category") +
  theme(axis.text.y = element_text(size = 8),
        strip.text = element_text(size = 10),
        legend.position = "none")

faceted_bar_plot
```

```{r}
# Define the thresholds for the categories (manual adjustment if needed)
thresholds <- quantile(summarized_data$total_attention_score, probs = c(0, 0.25, 0.5, 0.75, 1))
# For a more balanced categorization, you might manually adjust these thresholds.
# Example:
# thresholds <- c(0, 1000, 5000, 20000, Inf)

# Categorize the scores
summarized_data <- summarized_data %>%
  mutate(category = case_when(
    total_attention_score <= thresholds[2] ~ "Very Low",
    total_attention_score <= thresholds[3] ~ "Low",
    total_attention_score <= thresholds[4] ~ "Medium",
    TRUE ~ "High"
  ))

# Print the distribution of categories to debug
print(table(summarized_data$category))


```

# Function to create bar plots for each category

```{r}
create_separate_bar_plot <- function(data, category) {
  ggplot(data, aes(x = reorder(Category_2, total_attention_score), y = total_attention_score, fill = category)) +
    geom_bar(stat = "identity") +
    coord_flip() +
    theme_minimal() +
    labs(title = paste("Bar Plot of Total Attention Score -", category),
         x = "Broader Category",
         y = "Total Attention Score",
         fill = "Category") +
    theme(axis.text.y = element_text(size = 8),
          legend.position = "none")
}

 categories <- unique(summarized_data$category)
for (cat in categories) {
  cat_data <- summarized_data %>% filter(category == cat)
  bar_plot <- create_separate_bar_plot(cat_data, cat)
  print(bar_plot)
  ggsave(paste0("separate_bar_plot_", tolower(cat), ".png"), plot = bar_plot, width = 12, height = 8)
}


```

# Function to create lollipop charts for each category

```{r}
create_lollipop_chart <- function(data, category) {
  ggplot(data, aes(x = reorder(Category_2, total_attention_score), y = total_attention_score)) +
    geom_segment(aes(xend = Category_2, yend = 0), color = "skyblue") +
    geom_point(size = 4, color = "skyblue") +
    coord_flip() +
    theme_minimal() +
    labs(title = paste("Lollipop Chart of Total Attention Score -", category),
         x = "Broader Category",
         y = "Total Attention Score") +
    theme(axis.text.y = element_text(size = 8))
}

 categories <- unique(summarized_data$category)
for (cat in categories) {
  cat_data <- summarized_data %>% filter(category == cat)
  lollipop_chart <- create_lollipop_chart(cat_data, cat)
  print(lollipop_chart)
  ggsave(paste0("lollipop_chart_", tolower(cat), ".png"), plot = lollipop_chart, width = 12, height = 8)
}
```
```{r}
# Create a custom color palette
color_palette <- c("Very Low" = "#1f77b4", "Low" = "#ff7f0e", "Medium" = "#2ca02c", "High" = "#d62728")

# Create a faceted lollipop chart
faceted_lollipop_chart <- ggplot(summarized_data, aes(x = reorder(Category_2, total_attention_score), y = total_attention_score, color = category)) +
  geom_segment(aes(xend = Category_2, yend = 0), size = 1) +
  geom_point(size = 4) +
  coord_flip() +
  facet_wrap(~ category, scales = "free_y") +
  scale_color_manual(values = color_palette) +
  theme_minimal() +
  labs(title = "Faceted Lollipop Chart of Total Attention Score by Category",
       x = "Broader Category",
       y = "Total Attention Score",
       color = "Category") +
  theme(axis.text.y = element_text(size = 8),
        strip.text = element_text(size = 10))

# Display the faceted lollipop chart
print(faceted_lollipop_chart)
```
# Create a faceted grouped dot plot


```{r}
faceted_dot_plot <- ggplot(summarized_data, aes(x = reorder(Category_2, total_attention_score), y = total_attention_score, color = category)) +
  geom_point(size = 3) +
  coord_flip() +
  facet_wrap(~ category, scales = "free_y") +
  theme_minimal() +
  labs(title = "Faceted Dot Plot of Total Attention Score by Category",
       x = "Broader Category",
       y = "Total Attention Score",
       color = "Category") +
  theme(axis.text.y = element_text(size = 8),
        strip.text = element_text(size = 10),
        legend.position = "none")

faceted_dot_plot

```
threshold

```{r}
# Define the threshold for the categories
threshold <- median(summarized_data$total_attention_score)

# Categorize the scores into "High" and "Low"
summarized_data <- summarized_data %>%
  mutate(category = ifelse(total_attention_score > threshold, "High", "Low"))

# Define custom colors
custom_colors <- c("High" = "skyblue", "Low" = "salmon")

```

```{r}
# Function to create bar plots for each category
create_separate_bar_plot <- function(data, category) {
  ggplot(data, aes(x = reorder(Category_2, total_attention_score), y = total_attention_score, fill = category)) +
    geom_bar(stat = "identity", width = 1, color = "black") +  # Add borders to bars
    scale_fill_manual(values = custom_colors) +  # Use custom colors
    theme_minimal() +
    labs(title = paste("Bar Plot of Total Attention Score -", category),
         x = "Broader Category",
         y = "Total Attention Score",
         fill = "Category") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 10),  # Increase text size
          axis.text.y = element_text(size = 8),
          legend.position = "none")
}

# Create and save separate bar plots for each category
categories <- unique(summarized_data$category)
for (cat in categories) {
  cat_data <- summarized_data %>% filter(category == cat)
  bar_plot <- create_separate_bar_plot(cat_data, cat)
  print(bar_plot)
  ggsave(paste0("separate_bar_plot_", tolower(cat), ".png"), plot = bar_plot, width = 14, height = 7)
}

```



```{r}
# Create a faceted bar plot with separate panels for "High" and "Low" categories
faceted_bar_plot <- ggplot(summarized_data, aes(x = reorder(Category_2, total_attention_score), y = total_attention_score, fill = category)) +
  geom_bar(stat = "identity", width = 1, color = "black") +  # Add borders to bars
  scale_fill_manual(values = custom_colors) +  # Use custom colors
  facet_wrap(~ category, scales = "free") +  # Facet by category with free scales
  theme_minimal() +
  labs(title = "Faceted Bar Plot of Total Attention Score by Category",
       x = "Broader Category",
       y = "Total Attention Score",
       fill = "Category") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 10),  # Increase text size
        axis.text.y = element_text(size = 8),
        strip.text = element_text(size = 12),
        legend.position = "none")

# Display the faceted bar plot
print(faceted_bar_plot)

```
GWAS overall 

```{r}
# Visualize the distribution of 'total_attention_score'
ggplot(filtered_dataset, aes(x = total_attention_score)) +
  geom_histogram(binwidth = 500, fill = 'blue', color = 'black', alpha = 0.7) +
  labs(title = "Histogram of Total Attention Scores", x = "total_attention_score", y = "Frequency") +
  xlim(c(0, 35000))  


# Adding 1 to avoid log(0) which is undefined, for better visualization 
filtered_dataset$total_attention_score_log <- log10(filtered_dataset$total_attention_score + 1)

# Visualize the distribution with log transformation
ggplot(filtered_dataset, aes(x = total_attention_score_log)) +
  geom_histogram(binwidth = 0.1, fill = 'blue', color = 'black', alpha = 0.7) +
  labs(title = "Histogram of Log-Transformed Total Attention Scores (log(n + 1))", 
       x = "Log10(total attention Score + 1)", 
       y = "Frequency") +
  scale_x_continuous(breaks = seq(0, log10(max(filtered_dataset$total_attention_score + 1)), by = 1))



```

